---
title: "Netosis_Analyses_TW"
author: "Thijs (Mattheus) Wildschut"
date: "`r Sys.Date()`"
output: html_document
---

Built with R version `r getRversion()`

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

```{r load packages & functions, include=FALSE}
setwd("C:/Users/mwildschut/OneDrive - Vifor Pharma AG/Documents/R/Projects/R_CSL-Vifor_TW/Netosis")
source("../SourceFile_TW.R")
```

# Netosis analyses

## Experiment 10

### Load data
```{r Load data}
exp.folder = "C:/Users/mwildschut/OneDrive - Vifor Pharma AG/Documents/Incucyte/Netosis/Netosis_Exp10/CP_Analyses/"
data.img.raw = fread(paste0(exp.folder, "Netosis-10_Small_Image.csv"))
data.NET.raw = fread(paste0(exp.folder, "Netosis-10_NET.csv"))
data.nuc.raw = fread(paste0(exp.folder, "Netosis-10_Nucleus.csv"))
annot.plate = fread(paste0(exp.folder, "PlateMap_Exp10.csv"))
```

### Analyze timepoints at image-level
```{r Image analyses}
data.img = data.img.raw %>%
  `colnames<-`(str_remove(colnames(.), "Metadata_")) %>%
  left_join(annot.plate, by = "Well") %>%
  group_by(Timepoint, Condition, Concentration) %>%
  # dplyr::summarise(NET_TotalIntensity = mean(Intensity_TotalIntensity_CorrGreen_NET, na.rm = TRUE)) %>%
  dplyr::mutate(Concentration = as.factor(Concentration),
                NET_percentage = Count_NET/Count_Nucleus) %>%
  filter(!Timepoint %in% c("00h00m", "00h30m") & Condition == "Ionomycin (uM)")# "PMA (nM)")
ggplotly(ggplot(data.img, aes(x = Timepoint, y = NET_percentage, col = Concentration, group = Concentration)) +
  # stat_summary(fun.data = mean_sdl, geom = "errorbar") + #fun.args = list(mult = 1),
  stat_summary(fun.y = mean, geom = "line") +
  # geom_line() +
  facet_grid(.~Condition) +
  scale_color_viridis_d() + theme_bw() + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)))

```

## Neural Network analyses
### First step: get single cell crops around nucleus location
```{r Single cell crops}
library(magick)
crop.size = 50
objects = data.nuc.raw$ObjectNumber[data.nuc.raw$ImageNumber == 1]

foreach()
data.nuc = data.nuc.raw %>%
  `colnames<-`(str_remove(colnames(.), "Metadata_")) %>%
  select(ImageNumber, ObjectNumber, Experiment, Well, Image, Timepoint, Location_Center_X, Location_Center_Y) %>%
  mutate(Timepoint = paste0("00d", Timepoint),
         Filename = paste(Experiment, "Phase", Well, Image, Timepoint, sep = "_"),
         X = ifelse(Location_Center_X-(crop.size/2) > 0, Location_Center_X-(crop.size/2), 0),
         Y = ifelse(Location_Center_Y-(crop.size/2) > 0, Location_Center_Y-(crop.size/2), 0))

im = image_read(paste0("C:/Users/mwildschut/OneDrive - Vifor Pharma AG/Documents/Incucyte/Netosis/Netosis_Exp10/Raw_Images/",
                       data.nuc$Filename[21], ".tif"))[1]
im2 = image_crop(im, geometry_area(crop.size, crop.size, data.nuc$X[21], data.nuc$Y[21]))
image_write(im2, path = paste0("C:/Users/mwildschut/OneDrive - Vifor Pharma AG/Documents/Incucyte/Netosis/Netosis_Exp10/Cell_Crops/",
                        data.nuc$Filename[21], "_", data.nuc$ObjectNumber[21], ".tif"), format = "tiff", depth = 16)
im2
im
```